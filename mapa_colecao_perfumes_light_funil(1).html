<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico de Cole√ß√£o - Vers√£o Gratuita</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #d4af37, #f4e5b1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: #999;
            font-size: 1.1em;
        }

        .badge {
            display: inline-block;
            background: rgba(212, 175, 55, 0.2);
            color: #d4af37;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-top: 10px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        /* QUIZ STYLES */
        .quiz-section {
            display: none;
        }

        .quiz-section.active {
            display: block;
        }

        .question-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
        }

        .question-number {
            color: #d4af37;
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .question-title {
            color: white;
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 40px;
            line-height: 1.4;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .option-btn {
            background: rgba(212, 175, 55, 0.1);
            border: 2px solid rgba(212, 175, 55, 0.3);
            color: white;
            padding: 20px;
            border-radius: 12px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .option-btn:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: #d4af37;
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.3);
        }

        .option-btn.selected {
            background: linear-gradient(135deg, #d4af37, #f4e5b1);
            color: #1e1e1e;
            border-color: #d4af37;
        }

        .next-btn {
            background: linear-gradient(135deg, #d4af37, #f4e5b1);
            color: #1e1e1e;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.5;
            pointer-events: none;
        }

        .next-btn.enabled {
            opacity: 1;
            pointer-events: all;
        }

        .next-btn.enabled:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.5);
        }

        .section-title {
            color: white;
            font-size: 1.8em;
            margin: 40px 0 20px 0;
            text-align: center;
        }

        .interactive-note {
            background: rgba(100, 150, 255, 0.1);
            border: 2px solid rgba(100, 150, 255, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 40px;
            text-align: center;
            color: #9bc4ff;
        }

        .section-title {
            display: flex;
            justify-content: center;
            margin-top: 30px;
        }

        .balance-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 15px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
        }

        .balance-title {
            color: #d4af37;
            font-size: 1.8em;
            margin-bottom: 15px;
            text-align: center;
        }

        .balance-description {
            color: #ccc;
            text-align: center;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .context-section {
            background: rgba(100, 150, 255, 0.1);
            border: 2px solid rgba(100, 150, 255, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .context-title {
            color: #9bc4ff;
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .context-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .context-item label {
            color: #9bc4ff;
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .context-item input[type="text"],
        .context-item input[type="number"] {
            width: 100%;
            padding: 10px;
            font-size: 1em;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(100, 150, 255, 0.3);
            border-radius: 5px;
            color: white;
        }

        .context-item input[type="text"]:focus,
        .context-item input[type="number"]:focus {
            outline: none;
            border-color: #9bc4ff;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ccc;
            cursor: pointer;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            transition: all 0.2s ease;
        }

        .checkbox-label:hover {
            background: rgba(100, 150, 255, 0.1);
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .family-counter {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .counter-item {
            background: rgba(212, 175, 55, 0.1);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        .counter-item label {
            color: #d4af37;
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .counter-item input {
            width: 100%;
            padding: 10px;
            font-size: 1.2em;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 5px;
            color: white;
        }

        .counter-item input:focus {
            outline: none;
            border-color: #d4af37;
        }

        .analyze-btn {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            font-weight: 600;
            background: linear-gradient(90deg, #d4af37, #f4e5b1);
            color: #1e1e1e;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4);
        }

        .result-box {
            margin-top: 30px;
            background: rgba(212, 175, 55, 0.1);
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 25px;
        }

        .result-title {
            color: #d4af37;
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .result-content {
            color: white;
            font-size: 1.1em;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .result-advice {
            color: #ccc;
            line-height: 1.8;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .result-next {
            color: #9bc4ff;
            background: rgba(100, 150, 255, 0.1);
            border: 2px solid rgba(100, 150, 255, 0.3);
            padding: 15px;
            border-radius: 8px;
            line-height: 1.8;
        }

        .result-next strong {
            color: #fff;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }

            .options-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>DIAGN√ìSTICO DE COLE√á√ÉO</h1>
            <p class="subtitle">Descubra se sua cole√ß√£o est√° equilibrada</p>
            <span class="badge">üÜì VERS√ÉO GRATUITA</span>
        </header>

        <!-- QUIZ SECTION - Perguntas de qualifica√ß√£o -->
        <div id="quiz-1" class="quiz-section active">
            <div class="question-card">
                <div class="question-number">PERGUNTA 1 DE 3</div>
                <div class="question-title">Voc√™ j√° usa perfume?</div>
                <div class="options-grid">
                    <button class="option-btn" onclick="selectOption(1, 'sim-sempre', this)">Sim, sempre</button>
                    <button class="option-btn" onclick="selectOption(1, 'quando-lembro', this)">Quando lembro!</button>
                    <button class="option-btn" onclick="selectOption(1, 'nao-ligo', this)">N√£o ligo muito!</button>
                    <button class="option-btn" onclick="selectOption(1, 'nao-sei', this)">N√£o sei nada de perfumaria</button>
                </div>
                <button class="next-btn" id="next-1" onclick="nextQuestion(1)">Pr√≥xima ‚Üí</button>
            </div>
        </div>

        <div id="quiz-2" class="quiz-section">
            <div class="question-card">
                <div class="question-number">PERGUNTA 2 DE 3</div>
                <div class="question-title">Qual sua maior dificuldade ao escolher um perfume?</div>
                <div class="options-grid">
                    <button class="option-btn" onclick="selectOption(2, 'mesmo-tipo', this)">Compro sempre do mesmo tipo</button>
                    <button class="option-btn" onclick="selectOption(2, 'muitas-opcoes', this)">Muitas op√ß√µes e n√£o sei qual comprar</button>
                    <button class="option-btn" onclick="selectOption(2, 'influenciador', this)">Escuto o vendedor/influenciador e acabo perdendo dinheiro</button>
                    <button class="option-btn" onclick="selectOption(2, 'nao-compro', this)">Eu n√£o compro nunca</button>
                </div>
                <button class="next-btn" id="next-2" onclick="nextQuestion(2)">Pr√≥xima ‚Üí</button>
            </div>
        </div>

        <div id="quiz-3" class="quiz-section">
            <div class="question-card">
                <div class="question-number">PERGUNTA 3 DE 3</div>
                <div class="question-title">Qual seu or√ßamento para perfumes?</div>
                <div class="options-grid">
                    <button class="option-btn" onclick="selectOption(3, 'ate-350', this)">At√© R$350</button>
                    <button class="option-btn" onclick="selectOption(3, '350-1500', this)">R$350 a R$1500</button>
                    <button class="option-btn" onclick="selectOption(3, '1500-2500', this)">R$1500 a R$2500</button>
                    <button class="option-btn" onclick="selectOption(3, 'sem-limite', this)">O c√©u √© o limite</button>
                </div>
                <button class="next-btn" id="next-3" onclick="startDiagnostic()">Iniciar Diagn√≥stico ‚Üí</button>
            </div>
        </div>

        <!-- DIAGNOSTIC SECTION -->
        <div id="diagnostic-section" style="display: none;">
            <h2 class="section-title">üéØ DIAGN√ìSTICO: SUA COLE√á√ÉO EST√Å EQUILIBRADA?</h2>
            
            <div class="balance-section">
                <div class="balance-card">
                    <div class="balance-title">Identifique sua fam√≠lia dominante</div>
                    <div class="balance-description">
                        Conte quantos perfumes voc√™ tem de cada fam√≠lia. A fam√≠lia com mais perfumes √© sua dominante.
                    </div>

                    <div class="context-section">
                        <div class="context-title">üìç Contexto Pessoal</div>
                        <div class="context-grid">
                            <div class="context-item">
                                <label for="cidade">Cidade onde mora:</label>
                                <input type="text" id="cidade" placeholder="Ex: S√£o Paulo, Rio de Janeiro...">
                            </div>
                            <div class="context-item">
                                <label for="custo-medio">Custo m√©dio da cole√ß√£o (R$):</label>
                                <input type="number" id="custo-medio" placeholder="Ex: 150, 300, 500..." min="0">
                                <div style="color: #888; font-size: 0.85em; margin-top: 5px;">M√©dia que voc√™ gasta por perfume</div>
                            </div>
                            <div class="context-item">
                                <label>Ambiente de trabalho:</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="amb-fechado" value="fechado">
                                        <span>Fechado (escrit√≥rio, loja)</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="amb-aberto" value="aberto">
                                        <span>Aberto (obra, rua, campo)</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="amb-ambos" value="ambos">
                                        <span>Ambos (varia)</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="family-counter">
                        <div class="counter-item">
                            <label>üçã Fresco/C√≠trico</label>
                            <input type="number" id="fresco" min="0" max="20" value="0">
                        </div>
                        <div class="counter-item">
                            <label>üåø Arom√°tico/Verde</label>
                            <input type="number" id="aromatico" min="0" max="20" value="0">
                        </div>
                        <div class="counter-item">
                            <label>üçØ Doce/Gourmand</label>
                            <input type="number" id="doce" min="0" max="20" value="0">
                        </div>
                        <div class="counter-item">
                            <label>ü™µ Amadeirado</label>
                            <input type="number" id="amadeirado" min="0" max="20" value="0">
                        </div>
                        <div class="counter-item">
                            <label>üî• Especiado/Oriental</label>
                            <input type="number" id="especiado" min="0" max="20" value="0">
                        </div>
                        <div class="counter-item">
                            <label>üåä Aqu√°tico</label>
                            <input type="number" id="aquatico" min="0" max="20" value="0">
                        </div>
                    </div>

                    <button class="analyze-btn" onclick="analyzeCollection()">ANALISAR COLE√á√ÉO</button>

                    <div id="result" class="result-box" style="display: none;">
                        <div class="result-title">üìä RESULTADO DA AN√ÅLISE</div>
                        <div id="dominant-family" class="result-content"></div>
                        <div id="balance-advice" class="result-advice"></div>
                        <div id="next-purchase" class="result-next"></div>
                        
                        <!-- Bot√£o de I.A. que abre popup de convers√£o -->
                        <div style="margin-top: 30px; text-align: center;">
                            <div style="
                                background: linear-gradient(135deg, rgba(212, 175, 55, 0.2), rgba(212, 175, 55, 0.1));
                                border: 3px solid #d4af37;
                                border-radius: 12px;
                                padding: 20px 25px;
                                margin-bottom: 20px;
                                color: #f4e5b1;
                                font-size: 1.05em;
                                font-weight: 700;
                                line-height: 1.6;
                                box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
                            ">
                                üí° Seu diagn√≥stico ser√° copiado automaticamente - cole no chat ao abrir o Agente
                            </div>
                            
                            <button onclick="abrirPopupConversao()" style="
                                background: linear-gradient(135deg, #d4af37 0%, #f4e5b1 100%);
                                color: #1e1e1e;
                                border: none;
                                padding: 18px 40px;
                                border-radius: 12px;
                                font-size: 1.1em;
                                font-weight: 700;
                                cursor: pointer;
                                box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
                                transition: all 0.3s ease;
                                display: inline-flex;
                                align-items: center;
                                gap: 10px;
                            " onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 12px 35px rgba(212, 175, 55, 0.6)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 25px rgba(212, 175, 55, 0.4)';">
                                <span style="font-size: 1.3em;">ü§ñ</span>
                                <span>Deseja op√ß√µes personalizadas com I.A.?</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="interactive-note">
                <h3 style="margin-bottom: 15px;">üìã COMO FUNCIONA</h3>
                <p style="line-height: 1.8;">
                    1. Preencha seus dados pessoais (cidade, or√ßamento, ambiente)<br>
                    2. Conte quantos perfumes tem de cada fam√≠lia olfativa<br>
                    3. Clique em "ANALISAR COLE√á√ÉO" e descubra se est√° equilibrada<br>
                    4. Veja quais fam√≠lias est√£o faltando na sua cole√ß√£o
                </p>
            </div>
        </div>
    </div>

    <script>
        // URL do Google Sheets
        const SHEET_URL = 'https://script.google.com/macros/s/AKfycbyvClzOeCyClaqTIQBahHT9cgLgSmbkO5RaF1ZhjZfMeYs3jL38NqGoFDHgpXzSmIY/exec';

        // Fun√ß√£o para enviar dados ao Google Sheets
        function sendToSheet(data) {
            fetch(SHEET_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            }).catch(error => console.log('Dados enviados'));
        }

        // Armazenar respostas do quiz
        const quizAnswers = {
            q1: null,
            q2: null,
            q3: null
        };

        function selectOption(question, value, button) {
            // Salvar resposta
            quizAnswers[`q${question}`] = value;
            
            // Remover sele√ß√£o de todos os bot√µes da mesma pergunta
            const allButtons = button.parentElement.querySelectorAll('.option-btn');
            allButtons.forEach(btn => btn.classList.remove('selected'));
            
            // Selecionar bot√£o clicado
            button.classList.add('selected');
            
            // Habilitar bot√£o "Pr√≥xima"
            const nextBtn = document.getElementById(`next-${question}`);
            nextBtn.classList.add('enabled');
        }

        function nextQuestion(current) {
            // ENVIAR DADOS DA PERGUNTA ATUAL
            const etapa = `Pergunta ${current}`;
            const resposta = quizAnswers[`q${current}`];
            
            sendToSheet({
                etapa: etapa,
                q1: quizAnswers.q1,
                q2: quizAnswers.q2,
                q3: quizAnswers.q3,
                status: 'Em andamento'
            });
            
            // Esconder pergunta atual
            document.getElementById(`quiz-${current}`).classList.remove('active');
            
            // Mostrar pr√≥xima pergunta
            const next = current + 1;
            document.getElementById(`quiz-${next}`).classList.add('active');
            
            // Scroll para o topo
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function startDiagnostic() {
            // Salvar respostas do quiz no localStorage
            localStorage.setItem('quiz_answers', JSON.stringify(quizAnswers));
            
            // ENVIAR DADOS: Completou Quiz
            sendToSheet({
                etapa: 'Quiz Completo',
                q1: quizAnswers.q1,
                q2: quizAnswers.q2,
                q3: quizAnswers.q3,
                status: 'Iniciou Diagn√≥stico'
            });
            
            // Esconder quiz
            document.getElementById('quiz-3').style.display = 'none';
            
            // Mostrar se√ß√£o de diagn√≥stico
            document.getElementById('diagnostic-section').style.display = 'block';
            
            // Scroll para o topo
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Analisar cole√ß√£o com loading
        function analyzeCollection() {
            const families = {
                'fresco': { name: 'üçã Fresco/C√≠trico', value: parseInt(document.getElementById('fresco').value) || 0 },
                'aromatico': { name: 'üåø Arom√°tico/Verde', value: parseInt(document.getElementById('aromatico').value) || 0 },
                'doce': { name: 'üçØ Doce/Gourmand', value: parseInt(document.getElementById('doce').value) || 0 },
                'amadeirado': { name: 'ü™µ Amadeirado', value: parseInt(document.getElementById('amadeirado').value) || 0 },
                'especiado': { name: 'üî• Especiado/Oriental', value: parseInt(document.getElementById('especiado').value) || 0 },
                'aquatico': { name: 'üåä Aqu√°tico', value: parseInt(document.getElementById('aquatico').value) || 0 }
            };

            const total = Object.values(families).reduce((sum, f) => sum + f.value, 0);

            if (total === 0) {
                alert('Adicione pelo menos 1 perfume para analisar');
                return;
            }

            // MOSTRAR POPUP DE LOADING
            mostrarLoading();

            // Simular processamento por 2.5 segundos
            setTimeout(() => {
                fecharLoading();
                processarAnalise(families, total);
            }, 2500);
        }

        function mostrarLoading() {
            const overlay = document.createElement('div');
            overlay.id = 'loading-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                animation: fadeIn 0.3s ease;
            `;

            overlay.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #2d2d2d 0%, #1e1e1e 100%);
                    border: 3px solid #d4af37;
                    border-radius: 20px;
                    padding: 50px 60px;
                    text-align: center;
                    box-shadow: 0 20px 60px rgba(212, 175, 55, 0.5);
                    animation: slideUp 0.4s ease;
                ">
                    <div style="font-size: 4em; margin-bottom: 20px; animation: spin 1.5s linear infinite;">
                        üîÑ
                    </div>
                    <div style="color: #d4af37; font-size: 1.8em; font-weight: 700; margin-bottom: 15px;">
                        Analisando sua cole√ß√£o...
                    </div>
                    <div style="color: #ccc; font-size: 1em; margin-bottom: 25px;">
                        Processando dados e identificando padr√µes
                    </div>
                    
                    <div style="
                        width: 300px;
                        height: 8px;
                        background: rgba(212, 175, 55, 0.2);
                        border-radius: 10px;
                        overflow: hidden;
                        margin: 0 auto;
                    ">
                        <div id="progress-bar" style="
                            width: 0%;
                            height: 100%;
                            background: linear-gradient(90deg, #d4af37, #f4e5b1);
                            border-radius: 10px;
                            transition: width 0.3s ease;
                        "></div>
                    </div>
                </div>
            `;

            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideUp {
                    from { transform: translateY(30px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
                @keyframes fadeOut {
                    from { opacity: 1; }
                    to { opacity: 0; }
                }
            `;
            document.head.appendChild(style);

            document.body.appendChild(overlay);

            let progress = 0;
            const interval = setInterval(() => {
                progress += 4;
                const bar = document.getElementById('progress-bar');
                if (bar) bar.style.width = progress + '%';
                if (progress >= 100) clearInterval(interval);
            }, 100);
        }

        function fecharLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => overlay.remove(), 300);
            }
        }

        function processarAnalise(families, total) {
            const cidade = document.getElementById('cidade').value.trim();
            const custoMedio = parseInt(document.getElementById('custo-medio').value) || 0;
            const ambFechado = document.getElementById('amb-fechado').checked;
            const ambAberto = document.getElementById('amb-aberto').checked;
            const ambAmbos = document.getElementById('amb-ambos').checked;

            const cidadesQuentes = ['manaus', 'fortaleza', 'recife', 'salvador', 'natal', 'bel√©m', 'rio de janeiro', 'vit√≥ria', 'macei√≥', 'aracaju', 'teresina', 'palmas', 'cuiab√°', 'campo grande', 'goi√¢nia', 'bras√≠lia'];
            const cidadesFrias = ['curitiba', 'florian√≥polis', 'porto alegre', 'caxias do sul', 'gramado', 'canela', 'blumenau', 'joinville'];
            
            let climaRegiao = 'temperado';
            const cidadeLower = cidade.toLowerCase();
            
            if (cidadesQuentes.some(c => cidadeLower.includes(c))) {
                climaRegiao = 'quente';
            } else if (cidadesFrias.some(c => cidadeLower.includes(c))) {
                climaRegiao = 'frio';
            }

            const familiesRepresented = Object.values(families).filter(f => f.value > 0).length;

            let dominant = null;
            let maxValue = 0;
            Object.entries(families).forEach(([key, data]) => {
                if (data.value > maxValue) {
                    maxValue = data.value;
                    dominant = { key, ...data };
                }
            });

            const percentage = ((maxValue / total) * 100).toFixed(0);

            let level = '';
            let levelEmoji = '';
            let levelAdvice = '';

            if (total >= 1 && total <= 5) {
                levelEmoji = 'üéØ';
                level = 'INICIANTE';
                levelAdvice = 'Voc√™ est√° come√ßando. Foque nas 5 fun√ß√µes b√°sicas (calor, frio, trabalho, noite, assinatura) antes de diversificar.';
            } else if (total >= 6 && total <= 10) {
                if (familiesRepresented >= 4 && percentage < 50) {
                    levelEmoji = '‚ö°';
                    level = 'INTERMEDI√ÅRIO';
                    levelAdvice = 'Cole√ß√£o crescendo bem. Continue diversificando e evite redund√¢ncias na fam√≠lia dominante.';
                } else {
                    levelEmoji = '‚ö†Ô∏è';
                    level = 'INTERMEDI√ÅRIO (com desequil√≠brio)';
                    levelAdvice = 'Voc√™ tem quantidade de intermedi√°rio, mas est√° comprando muito da mesma fam√≠lia. Diversifique antes de expandir.';
                }
            } else if (total >= 11 && total <= 15) {
                if (familiesRepresented >= 5 && percentage <= 40) {
                    levelEmoji = 'üî•';
                    level = 'AVAN√áADO';
                    levelAdvice = 'Cole√ß√£o madura e equilibrada. Cada novo perfume deve preencher uma subfun√ß√£o espec√≠fica.';
                } else {
                    levelEmoji = '‚ö†Ô∏è';
                    level = 'AVAN√áADO (com redund√¢ncia)';
                    levelAdvice = 'Voc√™ tem muitos perfumes, mas com sobreposi√ß√£o. Identifique os redundantes e considere vender/trocar.';
                }
            } else {
                if (percentage <= 35 && familiesRepresented >= 5) {
                    levelEmoji = 'üëë';
                    level = 'COLECIONADOR EQUILIBRADO';
                    levelAdvice = 'Cole√ß√£o extensa e diversificada. Agora o foco √©: cada perfume tem fun√ß√£o clara?';
                } else {
                    levelEmoji = '‚ö†Ô∏è';
                    level = 'COLECIONADOR (com ac√∫mulo)';
                    levelAdvice = 'Voc√™ tem MUITOS perfumes, mas est√° acumulando redund√¢ncias. Pare de comprar e reorganize.';
                }
            }

            const missing = Object.entries(families)
                .filter(([key, data]) => data.value === 0)
                .map(([key, data]) => ({ key, ...data }));
            
            const weak = Object.entries(families)
                .filter(([key, data]) => data.value === 1)
                .map(([key, data]) => ({ key, ...data }));

            // ENVIAR DADOS: Diagn√≥stico Completo
            const ambientes = [];
            if (ambFechado) ambientes.push('Fechado');
            if (ambAberto) ambientes.push('Aberto');
            if (ambAmbos) ambientes.push('Ambos');

            const missingNames = [...missing, ...weak].map(f => f.name).join(', ');

            sendToSheet({
                etapa: 'Diagn√≥stico Completo',
                q1: quizAnswers.q1,
                q2: quizAnswers.q2,
                q3: quizAnswers.q3,
                cidade: cidade,
                orcamento: custoMedio,
                ambiente: ambientes.join(', '),
                totalPerfumes: total,
                familiaDominante: dominant.name,
                percentagemDominante: percentage + '%',
                familiasFaltando: missingNames || 'Nenhuma',
                nivel: level,
                status: 'Viu Resultado'
            });

            const resultDiv = document.getElementById('result');
            const dominantDiv = document.getElementById('dominant-family');
            const adviceDiv = document.getElementById('balance-advice');
            const nextDiv = document.getElementById('next-purchase');

            let contextoHTML = '';
            if (cidade) {
                let climaEmoji = climaRegiao === 'quente' ? 'üå°Ô∏è' : climaRegiao === 'frio' ? '‚ùÑÔ∏è' : 'üå§Ô∏è';
                contextoHTML += `<strong>Sua regi√£o:</strong> ${cidade} ${climaEmoji} (clima ${climaRegiao})<br>`;
            }
            if (custoMedio > 0) {
                let faixaOrcamento = '';
                let tipoCategoria = '';
                
                if (custoMedio <= 350) {
                    faixaOrcamento = 'econ√¥mica';
                    tipoCategoria = ' (nacionais, inspirados, √°rabes)';
                } else if (custoMedio > 350 && custoMedio < 1500) {
                    faixaOrcamento = 'intermedi√°ria';
                    tipoCategoria = ' (designers importados)';
                } else {
                    faixaOrcamento = 'premium';
                    tipoCategoria = ' (marcas de nicho)';
                }
                
                contextoHTML += `<strong>Custo m√©dio:</strong> R$ ${custoMedio} (faixa ${faixaOrcamento}${tipoCategoria})<br>`;
            }
            if (ambFechado || ambAberto || ambAmbos) {
                let ambientes = [];
                if (ambFechado) ambientes.push('Fechado');
                if (ambAberto) ambientes.push('Aberto');
                if (ambAmbos) ambientes.push('Ambos');
                contextoHTML += `<strong>Ambiente de trabalho:</strong> ${ambientes.join(', ')}<br>`;
            }

            dominantDiv.innerHTML = `
                <div style="background: rgba(212, 175, 55, 0.15); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #d4af37;">
                    <div style="font-size: 1.3em; margin-bottom: 10px;">${levelEmoji} <strong>SEU N√çVEL: ${level}</strong></div>
                    <div style="color: #ccc; font-size: 0.95em;">${levelAdvice}</div>
                </div>
                ${contextoHTML}
                <strong>Total de perfumes:</strong> ${total}<br>
                <strong>Fam√≠lias representadas:</strong> ${familiesRepresented}/6<br>
                <strong>Fam√≠lia dominante:</strong> ${dominant.name} (${maxValue} perfumes - ${percentage}%)
            `;

            let advice = '';
            let status = '';

            if (percentage >= 50) {
                status = '‚ö†Ô∏è <strong>COLE√á√ÉO DESBALANCEADA</strong>';
                advice = `Voc√™ est√° viciado em ${dominant.name}. Isso cria redund√¢ncia ‚Äî voc√™ tem v√°rios perfumes fazendo a mesma fun√ß√£o.`;
            } else if (percentage >= 35) {
                status = '‚ö° <strong>COLE√á√ÉO COM VI√âS</strong>';
                advice = `${dominant.name} domina sua cole√ß√£o, mas ainda h√° variedade. Seu pr√≥ximo perfume N√ÉO deve ser dessa fam√≠lia.`;
            } else {
                status = '‚úÖ <strong>COLE√á√ÉO EQUILIBRADA</strong>';
                advice = `Sua cole√ß√£o tem boa distribui√ß√£o entre fam√≠lias. Voc√™ tem op√ß√µes reais para diferentes contextos.`;
            }

            adviceDiv.innerHTML = status + '<br><br>' + advice;

            // Reusar missingNames j√° declarado acima
            
            let nextPurchase = '<strong>Fam√≠lias que voc√™ precisa adicionar:</strong><br><br>';
            if (missingNames) {
                nextPurchase += `üìç ${missingNames}<br><br>`;
            } else {
                nextPurchase += `Todas as fam√≠lias est√£o representadas!<br><br>`;
            }

            nextDiv.innerHTML = nextPurchase;

            resultDiv.style.display = 'block';
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Popup de convers√£o
        function abrirPopupConversao() {
            // ENVIAR DADOS: Clicou no bot√£o de I.A.
            sendToSheet({
                etapa: 'Clicou I.A.',
                q1: quizAnswers.q1,
                q2: quizAnswers.q2,
                q3: quizAnswers.q3,
                clicouIA: 'Sim',
                status: 'Interesse em Compra'
            });

            const overlay = document.createElement('div');
            overlay.id = 'popup-conversao';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                animation: fadeIn 0.3s ease;
            `;

            overlay.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #2d2d2d 0%, #1e1e1e 100%);
                    border: 3px solid #d4af37;
                    border-radius: 20px;
                    padding: 50px;
                    max-width: 600px;
                    box-shadow: 0 20px 60px rgba(212, 175, 55, 0.5);
                    animation: slideUp 0.4s ease;
                    text-align: center;
                ">
                    <div style="font-size: 4em; margin-bottom: 20px;">üîì</div>
                    <div style="color: #d4af37; font-size: 2em; font-weight: 700; margin-bottom: 20px;">
                        An√°lise Completa Bloqueada
                    </div>
                    <div style="color: #ccc; font-size: 1.1em; line-height: 1.8; margin-bottom: 30px;">
                        A an√°lise completa com:<br><br>
                        ‚úÖ <strong style="color: white;">Recomenda√ß√µes personalizadas</strong> de perfumes<br>
                        ‚úÖ <strong style="color: white;">Consultoria com I.A.</strong> especializada<br>
                        ‚úÖ <strong style="color: white;">Plano de a√ß√£o completo</strong> para sua cole√ß√£o<br><br>
                        Est√° dispon√≠vel apenas para alunos do<br>
                        <strong style="color: #d4af37; font-size: 1.2em;">Guia de Perfumes Masculinos</strong>
                    </div>
                    
                    <a href="https://pay.hotmart.com/H102542620H?checkoutMode=10" target="_blank" style="text-decoration: none;">
                        <button style="
                            background: linear-gradient(135deg, #d4af37 0%, #f4e5b1 100%);
                            color: #1e1e1e;
                            border: none;
                            padding: 20px 50px;
                            border-radius: 12px;
                            font-size: 1.3em;
                            font-weight: 700;
                            cursor: pointer;
                            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.5);
                            transition: all 0.3s ease;
                            margin-bottom: 20px;
                        " onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 15px 40px rgba(212, 175, 55, 0.7)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 10px 30px rgba(212, 175, 55, 0.5)';">
                            üöÄ ACESSAR O CURSO COMPLETO
                        </button>
                    </a>
                    
                    <div style="color: #888; font-size: 0.9em; cursor: pointer; margin-top: 15px;" onclick="fecharPopup()">
                        Fechar (ou pressione ESC)
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') fecharPopup();
            });
        }

        function fecharPopup() {
            const popup = document.getElementById('popup-conversao');
            if (popup) popup.remove();
        }

        // Salvar contadores
        ['fresco', 'aromatico', 'doce', 'amadeirado', 'especiado', 'aquatico'].forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener('change', function() {
                    localStorage.setItem(`count_${id}`, this.value);
                });
                
                const saved = localStorage.getItem(`count_${id}`);
                if (saved) {
                    input.value = saved;
                }
            }
        });

        const cidadeInput = document.getElementById('cidade');
        if (cidadeInput) {
            cidadeInput.addEventListener('change', function() {
                localStorage.setItem('cidade', this.value);
            });
            const savedCidade = localStorage.getItem('cidade');
            if (savedCidade) {
                cidadeInput.value = savedCidade;
            }
        }

        const custoInput = document.getElementById('custo-medio');
        if (custoInput) {
            custoInput.addEventListener('change', function() {
                localStorage.setItem('custo-medio', this.value);
            });
            const savedCusto = localStorage.getItem('custo-medio');
            if (savedCusto) {
                custoInput.value = savedCusto;
            }
        }

        ['amb-fechado', 'amb-aberto', 'amb-ambos'].forEach(id => {
            const checkbox = document.getElementById(id);
            if (checkbox) {
                checkbox.addEventListener('change', function() {
                    localStorage.setItem(id, this.checked);
                });
                const saved = localStorage.getItem(id);
                if (saved === 'true') {
                    checkbox.checked = true;
                }
            }
        });
    </script>
</body>
</html>